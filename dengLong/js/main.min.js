$(function(){var container;var camera,scene,renderer;var stageW=640;var stageH=window.innerHeight;var raycaster;var mouse;var selected;var target={x:0,y:0,z:0,lon:0,lat:0,phi:0,theta:0,fov:60};var area={w:200,h:800,d:200};var originLight;var lights=[];var lightMax=120;var dots=[];var dotMax=8;var dotMax2=60;var disMin=13;var imageLoadId=1;var imageLoadMax=9;var lightMaterial=[];var animId;var isPlay=false;var isDown=false;var skyTexture=['td/bg2_o_1.jpg','td/bg2_o_3.jpg','td/bg2_o_4.jpg','td/bg2_o_5.jpg','td/bg2_o_0.jpg','td/bg2_o_2.jpg'];var lightTexture=['td/bg.jpg','td/c1.png','td/c2.png','td/c3.png','td/c4.png','td/c5.png','td/c6.png','td/c7.png','td/c8.png','td/c9.png'];var bgImg;var canvas;var ctx;function webglAvailable(){var parser=new UAParser();if(parser.getDevice().type=='mobile'){var os=parser.getOS();var browser=parser.getBrowser();if(os.name=='iOS'&&Number(os.version.split('.')[0])>=8){return true}if(os.name=='Android'){var _a=os.version.split('.');if(Number(_a[0])>=5){return true}else if(Number(_a[0])>=4&&Number(_a[1])>=3&&Number(_a[0])>=3&&browser.name=='Chrome'){return true}}}else{try{var canvas=document.createElement('canvas');return!!(window.WebGLRenderingContext&&(canvas.getContext('webgl')||canvas.getContext('experimental-webgl')))}catch(e){return false}}return false}if(webglAvailable()){initLoading()}else{$('#no').html('<img class="bg" src="images/no/bg.jpg"/><img class="light" src="images/no/light.png"/><img class="txt" src="images/no/txt.png"/>');TweenLite.to('#no',0.5,{display:'block',opacity:1})}function checkUrl(){if(window.location.hash){var _id=Number(window.location.hash.substr(1));if(_id){selected=lights[_id];var _r=Math.atan2(selected.position.x,selected.position.z);selected.rotation.y=_r+1;pageOn(3)}}}function initLoading(){$('#loading .txt').text('0');var _assets=[];var _imgs=[];var _imgs=_imgs.concat(skyTexture).concat(['td/light.jpg']).concat(lightTexture);$.each(_imgs,function(index,obj){_assets.push($(new Image()).attr({src:obj})[0].src)});var _loadMax=_assets.length;var _loaded=0;if(_loadMax===0){this.completeHandle()}else{$.each(_assets,function(index,url){var _img=new Image();_img.onload=function(){_loaded++;$('#loading .txt').text(Math.floor(_loaded/_loadMax*100));if(_loaded>=_loadMax){init3D();initPage();TweenLite.to('#loading',0.5,{display:'none',opacity:0,delay:0.5})}};_img.src=url})}}function init3D(){camera=new THREE.PerspectiveCamera(target.fov,stageW/stageH,1,1000);camera.d=disMin;scene=new THREE.Scene();raycaster=new THREE.Raycaster();mouse=new THREE.Vector2();var ambient=new THREE.AmbientLight(0xffffff);scene.add(ambient);renderer=new THREE.WebGLRenderer();renderer.setPixelRatio(window.devicePixelRatio);renderer.setSize(stageW,stageH);loadSky();loadLight();initDot();var container=document.getElementById('container');container.appendChild(renderer.domElement);window.addEventListener('resize',onWindowResize,false);initControl();initDevice();playOn()}function loadSky(){var materials=[];$.each(skyTexture,function(index,obj){var texture=new THREE.Texture();var loader=new THREE.ImageLoader();loader.load(obj,function(image){texture.image=image;texture.needsUpdate=true});materials[index]=new THREE.MeshBasicMaterial({map:texture,overdraw:0.5})});var mesh=new THREE.Mesh(new THREE.BoxGeometry(1000,1000,1000,2,2,2),new THREE.MeshFaceMaterial(materials));mesh.scale.x=-1;scene.add(mesh)}function loadLight(){var texture=new THREE.Texture();var loader=new THREE.ImageLoader();loader.load('td/light.jpg',function(image){texture.image=image;texture.needsUpdate=true});var loader=new THREE.OBJLoader();loader.load('td/light.obj',function(object){object.traverse(function(child){if(child instanceof THREE.Mesh){child.material.map=texture;originLight=child;initMat()}})},function(xhr){console.log((xhr.loaded/xhr.total*100)+'% loaded')},function(xhr){console.log('An error happened')})}function initLight(){for(var i=0;i<lightMax;i++){var _light=originLight.clone();if(i==0){_light.position.y=1;_light.rotation.y=-1.6}else{_light.position.x=(Math.random()-0.5)*area.w;_light.position.y=(Math.random()-0.5)*area.h;_light.position.z=(Math.random()-0.5)*area.d;_light.rotation.y=Math.random()*Math.PI}_light.v={};if(i==0){_light.v.y=0;_light.v.ry=0;_light.v.rd=0}else{_light.v.y=Math.random()*0.1+0.05;_light.v.ry=Math.random()>0.5?0.003+Math.random()*0.003:-0.003-Math.random()*0.003;_light.v.rd=Math.random()*0.1}if(i!=0){_light.material=lightMaterial[i%imageLoadMax]}_light.material.transparent=true;_light.material.opacity=0.96;_light.lid=i;lights.push(_light);scene.add(_light)}introOn();setTimeout(function(){lights[0].v.y=0.05;lights[0].v.ry=Math.random()>0.5?0.003+Math.random()*0.003:-0.003-Math.random()*0.003;lights[0].v.rd=Math.random()*0.1;pageOn(1);checkUrl()},9000)}function introOn(){TweenLite.to(camera,10,{d:100,ease:Quart.easeInOut,delay:0.5});TweenLite.to(target,10,{lat:-50,ease:Quart.easeInOut,delay:0.5})}function introOff(){TweenLite.killTweensOf(target)}function renderLight(){$.each(lights,function(index,obj){if(!selected){obj.position.x+=Math.cos(obj.rotation.y)*obj.v.rd;obj.position.y+=obj.v.y;obj.position.z+=Math.sin(obj.rotation.y)*obj.v.rd}obj.rotation.y+=obj.v.ry;if(obj.position.y>area.h/2){obj.position.y-=area.h}})}function initMat(){canvas=document.getElementById('canvas');if(canvas.getContext){ctx=canvas.getContext('2d')}for(var i=0;i<imageLoadMax;i++){var mat=new THREE.MeshBasicMaterial({map:originLight.material.map});lightMaterial[i]=mat}var loader=new THREE.ImageLoader();loader.load(lightTexture[0],function(image){bgImg=image;for(var i=1;i<imageLoadMax;i++){reloadNextMat(i)}initLight()})}function reloadNextMat(imageLoadId){var texture=new THREE.Texture();var loader=new THREE.ImageLoader();loader.load(lightTexture[imageLoadId],function(image){ctx.clearRect(0,0,768,768);ctx.drawImage(bgImg,0,0,768,768);ctx.drawImage(image,0,0,768,768);var _img=new Image();_img.src=canvas.toDataURL("images/jpeg",0.7);setTimeout(function(){texture.image=_img;texture.needsUpdate=true;lightMaterial[imageLoadId-1].map=texture},1)})}function onWindowResize(){stageH=window.innerHeight;renderer.setSize(stageW,stageH);camera.projectionMatrix.makePerspective(target.fov,stageW/stageH,1,1100)}function initControl(){$('canvas').on('touchstart',onDocumentTouchStart);$('canvas').on('mousedown',onDocumentMouseDown);$('canvas').on('focus',function(){if(!isPlay)playOn()});$('canvas').on('blur',function(){if(isPlay)playOff()});$('canvas').on('touchstart',firstPlay);$('canvas').on('mousedown',firstPlay)}function firstPlay(){$('canvas').off('touchstart',firstPlay);$('canvas').off('mousedown',firstPlay);if(bgm.paused){checkBgm()}}function onDocumentTouchStart(event){introOff();isDown=true;event=event.touches[0];actionStart(event.clientX,event.clientY);$(document).on('touchmove',onDocumentTouchMove);$(document).on('touchend',onDocumentTouchEnd);return false}function onDocumentTouchMove(event){event=event.touches[0];actionMove(event.clientX,event.clientY);return false}function onDocumentTouchEnd(){isDown=false;$(document).off('touchmove',onDocumentTouchMove);$(document).off('touchend',onDocumentTouchEnd);return false}function onDocumentMouseDown(event){introOff();isDown=true;actionStart(event.clientX,event.clientY);$(document).on('mousemove',onDocumentMouseMove);$(document).on('mouseup',onDocumentMouseUp);return false}function onDocumentMouseMove(event){actionMove(event.clientX,event.clientY);return false}function onDocumentMouseUp(event){isDown=false;$(document).off('mousemove',onDocumentMouseMove);$(document).off('mouseup',onDocumentMouseUp);return false}function actionStart(x,y){onDownPointerX=x;onDownPointerY=y;onDownLon=target.lon;onDownLat=target.lat;mouse.x=(x/stageW)*2-1;mouse.y=-(y/stageH)*2+1;checkSelect()}function actionMove(x,y){target.lon=(x-onDownPointerX)*0.5+onDownLon;target.lat=(y-onDownPointerY)*0.5+onDownLat}function checkSelect(){raycaster.setFromCamera(mouse,camera);var intersects=raycaster.intersectObjects(lights);if(intersects.length>0){if(selected!=intersects[0].object){selected=intersects[0].object;var _r=Math.atan2(selected.position.x,selected.position.z);selected.rotation.y=_r+1;amObj.link="http://www.vmlim20.com.cn/demo/2015cny/"+'#'+selected.lid;tlObj.link="http://www.vmlim20.com.cn/demo/2015cny/"+'#'+selected.lid;pageOn(2)}}else{selected=null;amObj.link="http://www.vmlim20.com.cn/demo/2015cny/";tlObj.link="http://www.vmlim20.com.cn/demo/2015cny/";pageOff()}}function playOn(){isPlay=true;animId=requestAnimationFrame(playOn);renderLight();renderDot();render()}function playOff(){isPlay=false;cancelAnimationFrame(animId)}function render(){target.lat=Math.max(-55,Math.min(25,target.lat));target.phi=THREE.Math.degToRad(90-target.lat);target.theta=THREE.Math.degToRad(target.lon);if(selected){var _r=Math.atan2(selected.position.z,selected.position.x);var _x=selected.position.x+Math.cos(_r)*disMin;var _y=selected.position.y;var _z=selected.position.z+Math.sin(_r)*disMin;camera.position.x+=(_x-camera.position.x)*0.1;camera.position.y+=(_y-camera.position.y)*0.1;camera.position.z+=(_z-camera.position.z)*0.1;target.x+=(selected.position.x-target.x)*0.1;target.y+=(selected.position.y-2-target.y)*0.1;target.z+=(selected.position.z-target.z)*0.1;camera.lookAt(target);if(isDown){selected.rotation.y+=Math.max(-0.1,Math.min(0.1,THREE.Math.degToRad(target.lon-onDownLon)*0.1))}}else{var _x=camera.d*Math.sin(target.phi)*Math.cos(target.theta);var _y=camera.d*Math.cos(target.phi);var _z=camera.d*Math.sin(target.phi)*Math.sin(target.theta);camera.position.x+=(_x-camera.position.x)*0.1;camera.position.y+=(_y-camera.position.y)*0.1;camera.position.z+=(_z-camera.position.z)*0.1;target.x+=(scene.position.x-target.x)*0.1;target.y+=(scene.position.y-target.y)*0.1;target.z+=(scene.position.z-target.z)*0.1;camera.lookAt(target)}renderer.render(scene,camera)}function initDot(){var sprite=THREE.ImageUtils.loadTexture("td/dot.png");for(var i=0;i<dotMax;i++){var geometry=new THREE.Geometry();for(var j=0;j<dotMax2;j++){var vertex=new THREE.Vector3();vertex.x=Math.random()*1000-500;vertex.y=Math.random()*1000-500;vertex.z=Math.random()*1000-500;geometry.vertices.push(vertex)}var materials=new THREE.PointCloudMaterial({size:i+3,map:sprite,blending:THREE.AdditiveBlending,depthTest:false,transparent:true});var particles=new THREE.PointCloud(geometry,materials);particles.v={};particles.v.rx=(Math.random()-0.5)*0.001;particles.v.rz=(Math.random()-0.5)*0.001;particles.v.r=Math.random();particles.v.a=(Math.random()-0.5)*0.1;dots.push(particles);scene.add(particles)}}function renderDot(){for(var i=0;i<dotMax;i++){var particles=dots[i];particles.v.r+=particles.v.a;particles.rotation.x+=particles.v.rx;particles.rotation.z+=particles.v.rz;particles.material.opacity=Math.sin(particles.v.r)*0.4+0.7}}var bgm;function initPage(){$('#btnShare').on('click',function(){shareOn()});$('#btnShare2').on('click',function(){pageOn(2);selectNext()});$('#share').on('click',function(){shareOff()});bgm=document.getElementById('bgm');$('#muteOn,#muteOff').on('click',checkBgm)}function checkBgm(){if(bgm.paused){$('#muteOn').css({display:'block'});$('#muteOff').css({display:'none'});bgm.play()}else{$('#muteOn').css({display:'none'});$('#muteOff').css({display:'block'});bgm.pause()}}function shareOn(){TweenLite.to('#share',0.3,{opacity:1,display:'block'})}function shareOff(){TweenLite.to('#share',0.3,{opacity:0,display:'none'})}var curPageId;function pageOn(id){if(curPageId==id)return;pageOff();switch(id){case 1:TweenLite.to('#txt1',0.3,{opacity:1,display:'block'});break;case 2:TweenLite.to('#txt2',0.3,{opacity:1,display:'block'});TweenLite.to('#txt3',0.3,{opacity:1,display:'block'});TweenLite.to('#btnShare',0.3,{opacity:1,display:'block'});break;case 3:TweenLite.to('#txt4',0.3,{opacity:1,display:'block'});TweenLite.to('#txt5',0.3,{opacity:1,display:'block'});TweenLite.to('#btnShare2',0.3,{opacity:1,display:'block'});break}curPageId=id}function pageOff(){switch(curPageId){case 1:TweenLite.to('#txt1',0.3,{opacity:0,display:'none'});break;case 2:TweenLite.to('#txt2',0.3,{opacity:0,display:'none'});TweenLite.to('#txt3',0.3,{opacity:0,display:'none'});TweenLite.to('#btnShare',0.3,{opacity:0,display:'none'});break;case 3:TweenLite.to('#txt4',0.3,{opacity:0,display:'none'});TweenLite.to('#txt5',0.3,{opacity:0,display:'none'});TweenLite.to('#btnShare2',0.3,{opacity:0,display:'none'});break}curPageId=null}var SHAKE_THRESHOLD=2000;var acc={lastTime:0,x:null,y:null,z:null,last_x:0,last_y:0,last_z:0};function initDevice(){if(window.DeviceMotionEvent){window.addEventListener('devicemotion',deviceMotionHandler,false)}};function deviceMotionHandler(event){var acceleration=event.accelerationIncludingGravity;var curTime=new Date().getTime();if((curTime-acc.lastTime)>100){var diffTime=parseInt(curTime-acc.lastTime);acc.lastTime=curTime;acc.x=acceleration.x;acc.y=acceleration.y;acc.z=acceleration.z;var speed=Math.abs(acc.x+acc.y+acc.z-acc.last_x-acc.last_y-acc.last_z)/diffTime*10000;if(speed>SHAKE_THRESHOLD&&curPageId==2){selectNext()}acc.last_x=acc.x;acc.last_y=acc.y;acc.last_z=acc.z}}function selectNext(){if(!selected)return;if((selected.position.x-target.x>4)||(selected.position.y-target.y>4)||(selected.position.z-target.z>4))return;var _id=(selected.lid+1>=lightMax)?0:(selected.lid+1);selected=lights[_id];var _r=Math.atan2(selected.position.x,selected.position.z);selected.rotation.y=_r+1;amObj.link="http://www.vmlim20.com.cn/demo/2015cny/"+'#'+selected.lid;tlObj.link="http://www.vmlim20.com.cn/demo/2015cny/"+'#'+selected.lid}});